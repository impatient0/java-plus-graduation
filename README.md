# Explore With Me (Исследуй со мной)

Приложение-афиша, позволяющее пользователям делиться информацией об интересных событиях и находить компанию для участия в них. Изначально проект был разработан в команде в рамках обучения в Яндекс Практикуме.

В настоящее время проект развивается как индивидуальный дипломный проект. В рамках проекта монолитная архитектура была полностью разделена на независимые микросервисы, управляемые с помощью **Spring Cloud**.

## Оглавление

- [Архитектура](#архитектура)
- [Технологии](#технологии)
- [Структура проекта](#структура-проекта)
- [API Спецификации](#api-спецификации)
- [Начало работы](#начало-работы)
    - [Предварительные требования](#предварительные-требования)
    - [Сборка проекта](#сборка-проекта)
    - [Запуск с использованием Docker Compose (Рекомендуемый способ)](#запуск-с-использованием-docker-compose-рекомендуемый-способ)
    - [Локальный запуск для разработки (IntelliJ IDEA)](#локальный-запуск-для-разработки-intellij-idea)
- [Примеры использования API](#примеры-использования-api)
- [Тестирование](#тестирование)
- [Реализованная Дополнительная Функциональность: Комментарии](#реализованная-дополнительная-функциональность-комментарии)
- [История проекта и Автор](#история-проекта-и-автор)

## Архитектура

Приложение построено на основе микросервисной архитектуры. Инфраструктурные компоненты **Spring Cloud** обеспечивают отказоустойчивость и централизованное управление, а бизнес-логика разделена на независимые сервисы.

#### Инфраструктурные сервисы:

-   **API Gateway (`gateway-server`)**: Единая точка входа для всех внешних запросов. Отвечает за маршрутизацию к соответствующим микросервисам, балансировку нагрузки и реализует паттерны отказоустойчивости (Retry, Circuit Breaker).
-   **Discovery Server (`discovery-server`)**: Сервер обнаружения сервисов (Netflix Eureka). Все микросервисы регистрируются в нем, что позволяет им динамически находить друг друга по имени.
-   **Config Server (`config-server`)**: Сервер конфигурации, предоставляющий централизованные настройки для всех сервисов.

#### Сервисы бизнес-логики:

-   **`event-service`**: Управляет событиями (Events), категориями (Categories) и подборками (Compilations).
-   **`user-service`**: Управляет пользователями (Users).
-   **`request-service`**: Управляет заявками на участие (Participation Requests).
-   **`comment-service`**: Управляет комментариями (Comments).
-   **`stats-server`**: Управляет сбором и предоставлением статистики.

#### Межсервисное взаимодействие:

-   Для коммуникации между сервисами используется декларативный HTTP-клиент **OpenFeign**, интегрированный с Eureka.
-   Общие классы (DTO, интерфейсы клиентов, утилиты) вынесены в модуль **`interaction-api`**, который выступает в роли общего контракта для всех сервисов.

## Технологии

- Java 21
- Spring Boot 3.5.5
- Spring Cloud (Gateway, Netflix Eureka, Config)
- OpenFeign, Resilience4j (межсервисное взаимодействие и отказоустойчивость)
- Spring Data JPA, QueryDSL
- Spring MVC, Spring AOP (интеграция со StatsClient)
- PostgreSQL 16.1
- Maven
- Docker / Docker Compose
- Lombok, MapStruct
- JUnit 5, Mockito, Testcontainers
- Checkstyle, Spotbugs, Jacoco (контроль качества кода)

## Структура проекта

Проект является многомодульным и разделен на два логических слоя: `core` (бизнес-логика) и `infra` (инфраструктурные сервисы).

```
explore-with-me/
|
├── core/           (Модули, реализующие бизнес-логику)
│   ├── interaction-api/  (Общий контракт: DTO, Feign-клиенты)
│   ├── event-service/
│   ├── user-service/
│   ├── request-service/
│   ├── comment-service/
│   └── stats-service/
│       ├── stats-client/
│       ├── stats-dto/
│       └── stats-server/
|
└── infra/          (Инфраструктурные сервисы Spring Cloud)
    ├── config-server/      (Сервер конфигурации)
    ├── discovery-server/   (Сервер обнаружения)
    └── gateway-server/     (API-шлюз)
```

## API Спецификации

Спецификации API остаются без изменений, так как инфраструктурные преобразования не затронули публичный контракт сервисов.

-   **Основной сервис:** [`ewm-main-service-spec.json`](https://github.com/impatient0/java-plus-graduation/blob/main/ewm-main-service-spec.json)
-   **Сервис статистики:** [`ewm-stats-service.json`](https://github.com/impatient0/java-plus-graduation/blob/main/ewm-stats-service-spec.json)

## Начало работы

### Предварительные требования

- JDK 21
- Apache Maven 3.6+
- Docker и Docker Compose

### Сборка проекта

Для сборки всех модулей проекта выполните команду в корневой директории:
```bash
mvn clean install
```

### Запуск с использованием Docker Compose (Рекомендуемый способ)

Это основной способ запуска всего приложения, который поднимает все микросервисы и их зависимости.

1.  **Соберите проект:** `mvn clean install`
2.  **Запустите сервисы:**
    В корневой директории проекта выполните:
    ```bash
    docker-compose up --build
    ```
    Эта команда последовательно запустит всю инфраструктуру, базы данных и все сервисы бизнес-логики.

3.  **Доступ к приложению:**
    - **Единая точка входа (API Gateway):** `http://localhost:8080`
    - **Eureka Dashboard:** `http://localhost:8761`

4.  **Остановка сервисов:**
    ```bash
    docker-compose down -v
    ```

### Локальный запуск для разработки (IntelliJ IDEA)

Локальный запуск требует ручного старта всех сервисов в правильной последовательности. Это полезно для отладки конкретного сервиса.

**Важно:** Все сервисы (кроме `gateway-server` и `discovery-server`) запускаются на случайных портах и получают свою конфигурацию от `config-server`.

**Порядок запуска:**

1.  **`discovery-server`**: Запустите `DiscoveryServerApplication`. Дождитесь полного старта.
2.  **`config-server`**: Запустите `ConfigServerApplication`. Убедитесь, что он зарегистрировался в Eureka.
3.  **Сервисы бизнес-логики**: Запустите `StatsServerApplication`, `UserServiceApplication`, `EventServiceApplication`, `CommentServiceApplication`, `RequestServiceApplication`. Порядок между ними не важен.
4.  **`gateway-server`**: Запустите `GatewayServerApplication`.

После запуска всех сервисов **все API-запросы** должны направляться на порт API Gateway: `http://localhost:8080`.

## Примеры использования API

### Публичные эндпоинты Событий, Категорий, Подборок

-   **Получение списка событий с фильтрацией:**
    `GET http://localhost:8080/events?text=концерт&categories=1,2&paid=true&rangeStart=2025-06-01 00:00:00&rangeEnd=2025-06-30 23:59:59&onlyAvailable=true&sort=VIEWS&from=0&size=10`
    *(Предполагается, что даты и время URL-кодированы)*

-   **Получение подробной информации о событии:**
    `GET http://localhost:8080/events/{eventId}`

-   **Получение списка категорий:**
    `GET http://localhost:8080/categories?from=0&size=10`

-   **Получение категории по ID:**
    `GET http://localhost:8080/categories/{catId}`

-   **Получение списка подборок:**
    `GET http://localhost:8080/compilations?pinned=true&from=0&size=10`

-   **Получение подборки по ID:**
    `GET http://localhost:8080/compilations/{compId}`

### Публичные эндпоинты Комментариев

-   **Получение списка комментариев к событию:**
    `GET http://localhost:8080/events/{eventId}/comments?from=0&size=10&sort=createdOn,DESC`

## Тестирование

### Юнит и Интеграционные тесты

Для запуска всех тестов в проекте выполните:

```bash
mvn test
```
Проект использует JUnit 5, Mockito и Testcontainers для различных уровней тестирования (юнит-тесты, интеграционные тесты с БД). Отчеты о покрытии кода (Jacoco) генерируются в `target/site/jacoco/`.

### Postman-тесты для Дополнительной Функциональности

Для проверки работоспособности эндпоинтов реализованной дополнительной функциональности "Комментарии" подготовлена Postman-коллекция.

-   **Расположение:** `postman/feature.json` в корне репозитория.
-   **Проверка:** Тесты в коллекции проверяют основные сценарии использования API комментариев, включая коды ответов, базовый формат JSON и значения полей.

## Реализованная Дополнительная Функциональность: Комментарии

В рамках командного этапа проекта была выбрана и реализована дополнительная функциональность: **"Комментарии к событиям"**.

### Обзор функционала:

Реализована возможность для пользователей оставлять, редактировать и удалять свои комментарии к опубликованным событиям, а также для администраторов модерировать (удалять, восстанавливать) любые комментарии.

**Ключевые возможности:**

*   **Пользователи (Private API):**
    *   Создание комментария к событию (`POST /users/{userId}/comments?eventId={eventId}`).
        *   Комментарии можно оставлять только к опубликованным событиям, у которых включена опция комментирования.
    *   Редактирование своего комментария (`PATCH /users/{userId}/comments/{commentId}`).
        *   Возможно только в течение 6 часов после создания.
        *   Устанавливается флаг `isEdited`.
    *   "Мягкое" удаление своего комментария (`DELETE /users/{userId}/comments/{commentId}`).
        *   Комментарий помечается как удаленный (`isDeleted = true`), но не удаляется физически.
    *   Получение списка своих комментариев (`GET /users/{userId}/comments`).

*   **Администраторы (Admin API):**
    *   "Мягкое" удаление любого комментария (`DELETE /admin/comments/{commentId}`).
    *   Восстановление "мягко" удаленного комментария (`PATCH /admin/comments/{commentId}/restore`).
    *   Получение списка всех комментариев с фильтрацией (`GET /admin/comments`) по автору, событию, статусу удаления. В ответе (`CommentAdminDto`) передается флаг `isDeleted`.

*   **Все пользователи (Public API):**
    *   Получение списка комментариев для конкретного события (`GET /events/{eventId}/comments`).
        *   Возвращаются только не удаленные комментарии.
        *   Если комментарии к событию отключены (`Event.commentsEnabled = false`), возвращается пустой список.
        *   Поддерживается пагинация и сортировка (по умолчанию по дате создания, сначала новые).

*   **Интеграция с Событиями (`Event`):**
    *   В сущность `Event` добавлено поле `commentsEnabled` (boolean, default `true`), позволяющее инициатору или администратору включать/отключать возможность комментирования для события. Это поле управляется через эндпоинты создания/обновления событий.
    *   Настроено каскадное удаление комментариев при удалении связанного события или автора.

**Детальное описание новых эндпоинтов и DTO для комментариев представлено в обновленной спецификации API `ewm-main-service-spec.json`** (см. раздел [API Спецификации](#api-спецификации)).

## История проекта и Автор

Изначально данный проект был разработан в команде из четырех человек в рамках курса "Java-разработчик" от Яндекс Практикума. Командная работа включала в себя реализацию основного сервиса, сервиса статистики и дополнительной функциональности "Комментарии".

Над командной частью проекта работали:
- Иван Петровский (Team Lead) - [@impatient0](https://github.com/impatient0)
- Андрей Гагарский - [@Gagarskiy-Andrey](https://github.com/Gagarskiy-Andrey)
- Валерия Бутько - [@progingir](https://github.com/progingir)
- Сергей Филипповских - [@SergikF](https://github.com/SergikF)

В настоящее время проект развивается как **индивидуальный дипломный проект** Иваном Петровским. Дальнейшие доработки, рефакторинг и расширение функционала ведутся в рамках данного репозитория.
